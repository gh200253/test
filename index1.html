<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø©</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        body {
            font-family: 'Tahoma', sans-serif;
            background-color: #ffffff;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© --- */
        #sidebar {
            width: 320px;
            background-color: #f8f9fa;
            border-left: 2px solid #ddd;
            padding: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            box-shadow: -4px 0 10px rgba(0,0,0,0.05);
        }

        .section-title {
            color: #2c3e50;
            margin: 20px 0 5px 0;
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
            font-size: 15px;
            font-weight: bold;
        }

        label { font-size: 13px; font-weight: bold; color: #555; margin-top: 5px; display: block;}
        
        input, select, button {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-family: 'Tahoma', sans-serif;
            width: 95%;
            margin-bottom: 5px;
        }

        button { cursor: pointer; color: white; border: none; font-weight: bold; transition: 0.2s; }
        .btn-smart { background-color: #673AB7; } 
        .btn-manual { background-color: #27ae60; } 
        .btn-reset { background-color: #c0392b; margin-top: 20px; }
        
        button:hover { opacity: 0.9; transform: translateY(-2px); }

        /* --- Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø´Ø¬Ø±Ø© --- */
        #tree-container {
            flex-grow: 1;
            position: relative;
            background-image: radial-gradient(#e8f5e9 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* --- Ø³ØªØ§ÙŠÙ„Ø§Øª Ø§Ù„Ø±Ø³Ù… --- */
        .link { fill: none; stroke: #795548; stroke-width: 2px; }
        
        .node text {
            font-size: 14px; font-weight: 900;
            text-anchor: middle; paint-order: stroke;
            stroke: #fff; stroke-width: 3px;
            pointer-events: none; fill: #000;
        }

        .node image, .node circle {
            cursor: pointer;
            transition: transform 0.2s ease;
            transform-origin: center;
        }
        .node image:hover, .node circle:hover { transform: scale(1.2); }

    </style>
</head>
<body>

    <div id="sidebar">
        <h3>ğŸŒ³ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h3>

        <div class="section-title">ğŸš€ Ø¥Ø¶Ø§ÙØ© Ø³Ù„Ø³Ù„Ø© (Ø§Ø³Ù… ÙƒØ§Ù…Ù„)</div>
        <label>Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ):</label>
        <input type="text" id="fullNameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§...">
        <div class="note">
            * Ø§Ù„ÙƒÙˆØ¯ Ø³ÙŠØ¨Ø­Ø« Ø¹Ù† <b>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£Ø®ÙŠØ±</b> ÙÙŠ Ø§Ù„Ø´Ø¬Ø±Ø©:<br>
            - Ù„Ùˆ ÙˆØ¬Ø¯Ù‡: ÙŠØ±Ø¨Ø· Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¨Ù‡.<br>
            - Ù„Ùˆ Ù„Ù… ÙŠØ¬Ø¯Ù‡: ÙŠØ¶ÙŠÙÙ‡ ÙƒÙØ±Ø¹ Ø¬Ø¯ÙŠØ¯.<br>
            - <b>Ù„Ù† ÙŠØªÙ… Ø­Ø°Ù Ø£ÙŠ Ø§Ø³Ù… ØªÙƒØªØ¨Ù‡ Ø§Ù„Ø¢Ù†.</b>
        </div>
        <button class="btn-smart" onclick="addByFullName()">âœ¨ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ù„Ø³Ù„Ø©</button>


        <div class="section-title">ğŸ› ï¸ Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ©</div>
        <label>Ø§Ù„Ø£Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø±:</label>
        <input type="text" id="parentName" placeholder="Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¬Ø±Ø©..." readonly>
        <label>Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label>
        <input type="text" id="childName" placeholder="Ø§Ù„Ø§Ø³Ù…...">
        <label for="childType">Ø§Ù„Ù†ÙˆØ¹:</label>
        <select id="childType">
            <option value="leaf">Ø­ÙÙŠØ¯ (ÙˆØ±Ù‚Ø©)</option>
            <option value="fruit">Ø§Ø¨Ù† (Ø«Ù…Ø±Ø©)</option>
        </select>
        <button class="btn-manual" onclick="addManual()">+ Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¯</button>
        
        <button class="btn-reset" onclick="resetTree()">âš ï¸ Ù…Ø³Ø­ Ø§Ù„Ø´Ø¬Ø±Ø©</button>
    </div>

    <div id="tree-container"></div>

    <script>
        // ---------------------------------------------------------
        // 1. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        // ---------------------------------------------------------
        const defaultData = {
            name: "Ø§Ù„Ø¬Ø¯",
            type: "root",
            children: []
        };

        let treeData = JSON.parse(localStorage.getItem('myFixedTree')) || defaultData;
        let svg, g;
        const width = window.innerWidth - 320; 
        const height = window.innerHeight;

        function saveData() { localStorage.setItem('myFixedTree', JSON.stringify(treeData)); }

        // ---------------------------------------------------------
        // 2. Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø°ÙƒÙŠ (ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‡Ù†Ø§) ğŸ› ï¸
        // ---------------------------------------------------------
        
        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù‚Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† Ø¨Ø§Ù„Ø´Ø¬Ø±Ø©
        function findNodeByName(node, name) {
            if (node.name === name) return node;
            if (node.children) {
                for (let child of node.children) {
                    let found = findNodeByName(child, name);
                    if (found) return found;
                }
            }
            return null;
        }

        function addByFullName() {
            const input = document.getElementById("fullNameInput").value.trim();
            if (!input) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù…!");

            // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø§Ø³Ù… Ù„Ù…ØµÙÙˆÙØ©
            let names = input.split(/\s+/); 
            if (names.length < 2) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");

            // Ø¹ÙƒØ³ Ø§Ù„Ù…ØµÙÙˆÙØ©: [Ø§Ù„Ø¬Ø¯ØŒ Ø§Ù„Ø£Ø¨ØŒ Ø§Ù„Ø§Ø¨Ù†]
            let hierarchy = names.reverse(); 

            // Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£Ø®ÙŠØ± Ø§Ù„Ø°ÙŠ ÙƒØªØ¨ØªÙ‡ (Ø±Ø£Ø³ Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
            const topName = hierarchy[0]; 

            // 1. Ù‡Ù„ Ø§Ù„Ø´Ø¬Ø±Ø© Ù„Ø³Ù‡ Ø¬Ø¯ÙŠØ¯Ø© (Ø¨Ø§Ø³Ù… "Ø§Ù„Ø¬Ø¯" Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)ØŸ
            if (treeData.name === "Ø§Ù„Ø¬Ø¯" && treeData.children.length === 0) {
                treeData.name = topName; // Ù†ØºÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ Ù„Ù„Ø£Ø³Ù… Ø§Ù„Ù„ÙŠ ÙƒØªØ¨ØªÙ‡
                hierarchy.shift(); // Ù†Ø­Ø°Ù Ø§Ù„Ø§Ø³Ù… Ù„Ø£Ù†Ù‡ Ø£ØµØ¨Ø­ Ù‡Ùˆ Ø§Ù„Ø¬Ø°Ø¹
                processHierarchy(treeData, hierarchy); // Ù†ÙƒÙ…Ù„ Ø§Ù„Ø¨Ø§Ù‚ÙŠ
            } 
            else {
                // 2. Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ø³Ù… Ø¯Ù‡ ÙÙŠ Ø§Ù„Ø´Ø¬Ø±Ø©
                let foundNode = findNodeByName(treeData, topName);

                if (foundNode) {
                    // Ù„Ù‚ÙŠÙ†Ø§Ù‡! Ù†Ø±Ø¨Ø· Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¨ÙŠÙ‡
                    hierarchy.shift(); // Ù†Ø­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠØªÙƒØ±Ø±Ø´
                    processHierarchy(foundNode, hierarchy);
                } else {
                    // Ù…Ø§ Ù„Ù‚ÙŠÙ†Ø§Ù‡ÙˆØ´! ÙŠØ¨Ù‚Ù‰ Ø¯Ù‡ ÙØ±Ø¹ Ø¬Ø¯ÙŠØ¯ Ù†Ø¶ÙŠÙÙ‡ ØªØ­Øª "Ø§Ù„Ø¬Ø¯ Ø§Ù„ÙƒØ¨ÙŠØ±" Ø§Ù„Ø­Ø§Ù„ÙŠ
                    // Ø£Ùˆ Ù†Ø¹ØªØ¨Ø±Ù‡ Ù‡Ùˆ ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„ÙŠ Ù…Ø¹Ø§Ù‡ ÙØ±Ø¹ Ø¬Ø¯ÙŠØ¯
                    processHierarchy(treeData, hierarchy);
                }
            }
            
            refresh();
            document.getElementById("fullNameInput").value = "";
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±ÙŠØ©
        function processHierarchy(currentNode, namesList) {
            if (namesList.length === 0) return;

            const nameToAdd = namesList[0];
            const isLastOne = (namesList.length === 1);
            const typeToAdd = isLastOne ? "leaf" : "fruit"; // Ø§Ù„Ø£Ø®ÙŠØ± ÙˆØ±Ù‚Ø©ØŒ ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ Ø¯ÙˆØ§Ø¦Ø±

            let foundChild = null;
            if (currentNode.children) {
                foundChild = currentNode.children.find(c => c.name === nameToAdd);
            } else {
                currentNode.children = [];
            }

            if (foundChild) {
                // Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ù†ÙƒÙ…Ù„ ØªØ­ØªÙ‡
                processHierarchy(foundChild, namesList.slice(1));
            } else {
                // ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ù†Ø´Ø¦Ù‡
                let newNode = {
                    name: nameToAdd,
                    type: typeToAdd,
                    children: []
                };
                currentNode.children.push(newNode);
                processHierarchy(newNode, namesList.slice(1));
            }
        }

        // ---------------------------------------------------------
        // 3. Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
        // ---------------------------------------------------------
        function addManual() {
            const parentName = document.getElementById("parentName").value;
            const childName = document.getElementById("childName").value;
            const childType = document.getElementById("childType").value;

            if (!parentName || !childName) return alert("Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

            if (findAndAddManual(treeData, parentName, childName, childType)) {
                refresh();
                document.getElementById("childName").value = "";
            } else {
                alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¨.");
            }
        }

        function findAndAddManual(node, pName, cName, cType) {
            if (node.name === pName) {
                if (!node.children) node.children = [];
                node.children.push({ name: cName, type: cType, children: [] });
                return true;
            }
            if (node.children) {
                for (let child of node.children) {
                    if (findAndAddManual(child, pName, cName, cType)) return true;
                }
            }
            return false;
        }

        function refresh() {
            saveData();
            updateTree();
            d3.selectAll("image").style("opacity", 1);
            d3.selectAll("circle").style("opacity", 1);
        }

        function resetTree() {
            if(confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ø¬Ø±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.. Ù…ØªØ£ÙƒØ¯ØŸ")) {
                localStorage.removeItem('myFixedTree');
                location.reload();
            }
        }

        // ---------------------------------------------------------
        // 4. Ø§Ù„Ø±Ø³Ù…
        // ---------------------------------------------------------
        function initTree() {
            svg = d3.select("#tree-container").append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .call(d3.zoom().scaleExtent([0.1, 3]).on("zoom", (e) => g.attr("transform", e.transform))
                .filter(event => !event.ctrlKey && event.type !== 'dblclick')) 
                .append("g")
                .attr("transform", "translate(0, 150)");
            g = svg.append("g");
            updateTree();
        }

        function updateTree() {
            g.selectAll("*").remove();
            const root = d3.hierarchy(treeData);
            const treeLayout = d3.tree().nodeSize([100, 160]); 
            treeLayout(root);

            const nodes = root.descendants();
            const links = root.links();

            // Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
            g.selectAll(".link").data(links).enter().append("path")
                .attr("class", "link")
                .attr("d", d3.linkVertical().x(d => d.x + (width/2)).y(d => height - d.y - 100));

            // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
            const nodeGroup = g.selectAll(".node").data(nodes).enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x + (width/2)},${height - d.y - 100})`);

            // Ø§Ù„ØµÙˆØ± (Ø§Ù„Ø¬Ø°ÙˆØ± ÙˆØ§Ù„Ø£ÙˆØ±Ø§Ù‚)
            nodeGroup.filter(d => d.data.type === 'root' || d.data.type === 'leaf')
                .append("image")
                .attr("xlink:href", d => d.data.type === "root" ? "img/root.png" : "img/leaf.png")
                .attr("width", d => d.data.type === "root" ? 120 : 60)
                .attr("height", d => d.data.type === "root" ? 120 : 60)
                .attr("x", d => d.data.type === "root" ? -60 : -30)
                .attr("y", d => d.data.type === "root" ? -60 : -30);

            // Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± (ÙÙˆØ§ÙƒÙ‡)
            nodeGroup.filter(d => d.data.type === 'fruit')
                .append("circle").attr("r", 25)
                .style("fill", "#FF9800").style("stroke", "#F57C00").style("stroke-width", "3px");

            // Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
            nodeGroup.append("text")
                .attr("dy", d => d.data.type === 'root' ? 10 : 5)
                .text(d => d.data.name);

            // Ø§Ù„Ù†Ù‚Ø±
            nodeGroup.on("click", (event, d) => {
                event.stopPropagation();
                document.getElementById("parentName").value = d.data.name;
                d3.selectAll("image").style("opacity", 0.4);
                d3.selectAll("circle").style("opacity", 0.4);
                const sel = d3.select(event.currentTarget);
                sel.select("image").style("opacity", 1);
                sel.select("circle").style("opacity", 1);
            });
        }

        initTree();
    </script>
</body>
</html>