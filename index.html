<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ©</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        body {
            font-family: 'Tahoma', sans-serif;
            background-color: #ffffff;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© --- */
        #sidebar {
            width: 300px;
            background-color: #f8f9fa;
            border-left: 2px solid #ddd;
            padding: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: -4px 0 10px rgba(0,0,0,0.05);
        }

        #sidebar h3 { color: #2c3e50; margin-top: 0; text-align: center; }
        
        input, select, button {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-family: 'Tahoma', sans-serif;
            outline: none;
            width: 90%;
        }

        button.add-btn { background-color: #27ae60; color: white; border: none; cursor: pointer; font-weight: bold; margin-top: 10px; }
        button.reset-btn { background-color: #c0392b; color: white; margin-top: 20px; border: none; cursor: pointer; }
        button:hover { opacity: 0.9; }

        /* --- Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø´Ø¬Ø±Ø© --- */
        #tree-container {
            flex-grow: 1;
            position: relative;
            background-image: radial-gradient(#e8f5e9 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .link {
            fill: none;
            stroke: #795548;
            stroke-width: 2px;
        }

        .node text {
            font-size: 14px;
            font-weight: 900;
            text-anchor: middle;
            paint-order: stroke;
            stroke: #fff;
            stroke-width: 3px;
            pointer-events: none; /* Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¯Ø§Ø®Ù„ */
            fill: #000;
        }

        /* --- Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù‡Ù†Ø§ --- */
        /* Ù†Ø·Ø¨Ù‚ Ø§Ù„Ø­Ø±ÙƒØ© Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø¯Ø§Ø¦Ø±Ø© ÙÙ‚Ø·ØŒ ÙˆÙ„ÙŠØ³ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© */
        .node image, .node circle {
            cursor: pointer;
            transition: transform 0.2s ease; /* Ø­Ø±ÙƒØ© Ù†Ø§Ø¹Ù…Ø© ÙˆØ³Ø±ÙŠØ¹Ø© */
            transform-origin: center; /* Ø§Ù„ØªÙƒØ¨ÙŠØ± Ù…Ù† Ø§Ù„Ù…Ù†ØªØµÙ */
        }

        /* Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø§Ù„Ù…Ø§ÙˆØ³ØŒ Ù†ÙƒØ¨Ø± Ø§Ù„ØµÙˆØ±Ø© ÙÙ‚Ø· */
        .node image:hover, .node circle:hover {
            transform: scale(1.2); /* ØªÙƒØ¨ÙŠØ± Ø¨Ø³ÙŠØ· ÙˆØ«Ø§Ø¨Øª */
        }

        #parentName {
            background-color: #e9ecef;
            font-weight: bold;
            text-align: center;
        }

    </style>
</head>
<body>

    <div id="sidebar">
        <h3>ğŸŒ³ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h3>
        
        <label>Ø§Ù„Ø£Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø±:</label>
        <input type="text" id="parentName" placeholder="Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø´Ø¬Ø±Ø©..." readonly>
        
        <label>Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label>
        <input type="text" id="childName" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…...">
        
        <label for="childType">Ø§Ù„Ù†ÙˆØ¹:</label>
        <select id="childType">
            <option value="leaf">Ø­ÙÙŠØ¯ (ÙˆØ±Ù‚Ø©)</option>
            <option value="fruit">Ø§Ø¨Ù† (Ø¯Ø§Ø¦Ø±Ø©/Ø«Ù…Ø±Ø©)</option>
        </select>

        <button class="add-btn" onclick="addMember()">+ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ø¬Ø±Ø© ÙˆØ­ÙØ¸</button>
        <hr>
        <button class="reset-btn" onclick="resetTree()">âš ï¸ Ù…Ø³Ø­ Ø§Ù„Ø´Ø¬Ø±Ø©</button>
    </div>

    <div id="tree-container"></div>

    <script>
        // 1. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø­ÙØ¸
        const defaultData = {
            name: "Ù…Ø­Ù…Ø¯ ",
            type: "root",
            children: [
                {
                    name: " ÙƒÙ…Ø§Ù„",
                    type: "fruit",
                    children: [ { name: " Ù…Ø­Ù…Ø¯ ", type: "leaf" } ]
                }
            ]
        };

        let treeData = JSON.parse(localStorage.getItem('myFamilyTree')) || defaultData;

        function saveData() { localStorage.setItem('myFamilyTree', JSON.stringify(treeData)); }
        function resetTree() {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
                localStorage.removeItem('myFamilyTree');
                location.reload();
            }
        }

        // 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø³Ù…
        let svg, g;
        const width = window.innerWidth - 300; 
        const height = window.innerHeight;

        function initTree() {
            svg = d3.select("#tree-container").append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø²ÙˆÙˆÙ… Ø¨Ø§Ù„Ø¯Ø¨Ù„ ÙƒÙ„ÙŠÙƒ Ù„Ù…Ù†Ø¹ Ø§Ù„Ù‚ÙØ²Ø§Øª Ø§Ù„Ù…ÙØ§Ø¬Ø¦Ø©
                .call(d3.zoom().scaleExtent([0.1, 3]).on("zoom", (e) => {
                    g.attr("transform", e.transform);
                }).filter(event => !event.ctrlKey && event.type !== 'dblclick')) 
                .append("g")
                .attr("transform", "translate(0, 150)");
            
            g = svg.append("g");
            updateTree();
        }

        // 3. Ø§Ù„Ø±Ø³Ù…
        function updateTree() {
            g.selectAll("*").remove();

            const root = d3.hierarchy(treeData);
            const treeLayout = d3.tree().nodeSize([100, 150]); 
            treeLayout(root);

            const nodes = root.descendants();
            const links = root.links();

            // Ø§Ù„Ø®Ø·ÙˆØ·
            g.selectAll(".link")
                .data(links)
                .enter().append("path")
                .attr("class", "link")
                .attr("d", d3.linkVertical()
                    .x(d => d.x + (width / 2)) 
                    .y(d => height - d.y - 100) 
                );

            // Ø§Ù„Ø¹Ù‚Ø¯ (Group Container)
            const nodeGroup = g.selectAll(".node")
                .data(nodes)
                .enter().append("g")
                .attr("class", "node")
                // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ…ÙˆØ¶Ø¹ Ù‡Ù†Ø§ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
                .attr("transform", d => `translate(${d.x + (width / 2)},${height - d.y - 100})`);

            // Ø§Ù„ØµÙˆØ± (Ø§Ù„Ø¬Ø°ÙˆØ± ÙˆØ§Ù„Ø£ÙˆØ±Ø§Ù‚)
            nodeGroup.filter(d => d.data.type === 'root' || d.data.type === 'leaf')
                .append("image")
                .attr("xlink:href", d => {
                    if(d.data.type === "root") return "img/root.png"; 
                    return "img/leaf.png";
                })
                .attr("width", d => d.data.type === "root" ? 120 : 60)
                .attr("height", d => d.data.type === "root" ? 120 : 60)
                .attr("x", d => d.data.type === "root" ? -60 : -30) // ØªÙˆØ³ÙŠØ· Ø§Ù„ØµÙˆØ±Ø©
                .attr("y", d => d.data.type === "root" ? -60 : -30);

            // Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± (Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡)
            nodeGroup.filter(d => d.data.type === 'fruit')
                .append("circle")
                .attr("r", 25)
                .style("fill", "#FF9800")
                .style("stroke", "#F57C00")
                .style("stroke-width", "3px");

            // Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
            nodeGroup.append("text")
                .attr("dy", d => d.data.type === 'root' ? 10 : 5) 
                .text(d => d.data.name);

            // Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± (Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø­Ø±ÙƒØ©)
            nodeGroup.on("click", (event, d) => {
                // Ù…Ù†Ø¹ Ø§Ù†ØªØ´Ø§Ø± Ø§Ù„Ø­Ø¯Ø« Ø­ØªÙ‰ Ù„Ø§ ÙŠØªØ¹Ø§Ø±Ø¶ Ù…Ø¹ Ø§Ù„Ø²ÙˆÙˆÙ…
                event.stopPropagation();

                document.getElementById("parentName").value = d.data.name;
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´ÙØ§ÙÙŠØ©
                d3.selectAll("image").style("opacity", 0.4);
                d3.selectAll("circle").style("opacity", 0.4);
                
                // ØªØ¸Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø®ØªØ§Ø± ÙÙ‚Ø·
                const selected = d3.select(event.currentTarget);
                selected.select("image").style("opacity", 1);
                selected.select("circle").style("opacity", 1);
            });
        }

        // 4. Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        function findNodeAndAddChild(node, parentName, newChildName, newType) {
            if (node.name === parentName) {
                if (!node.children) node.children = [];
                node.children.push({ name: newChildName, type: newType, children: [] });
                return true;
            }
            if (node.children) {
                for (let child of node.children) {
                    if (findNodeAndAddChild(child, parentName, newChildName, newType)) return true;
                }
            }
            return false;
        }

        function addMember() {
            const parentName = document.getElementById("parentName").value;
            const childName = document.getElementById("childName").value;
            const childType = document.getElementById("childType").value;

            if (!parentName || !childName) { alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); return; }

            if (findNodeAndAddChild(treeData, parentName, childName, childType)) {
                saveData();
                updateTree();
                document.getElementById("childName").value = "";
                d3.selectAll("image").style("opacity", 1);
                d3.selectAll("circle").style("opacity", 1);
            } else {
                alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¨.");
            }
        }

        initTree();
    </script>
</body>
</html>